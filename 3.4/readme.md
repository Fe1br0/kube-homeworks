# Домашнее задание к занятию «Обновление приложений»

### Цель задания

Выбрать и настроить стратегию обновления приложения.

### Чеклист готовности к домашнему заданию

1. Кластер K8s.

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Документация Updating a Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment).
2. [Статья про стратегии обновлений](https://habr.com/ru/companies/flant/articles/471620/).

-----

### Задание 1. Выбрать стратегию обновления приложения и описать ваш выбор

1. Имеется приложение, состоящее из нескольких реплик, которое требуется обновить.
2. Ресурсы, выделенные для приложения, ограничены, и нет возможности их увеличить.
3. Запас по ресурсам в менее загруженный момент времени составляет 20%.
4. Обновление мажорное, новые версии приложения не умеют работать со старыми.
5. Вам нужно объяснить свой выбор стратегии обновления приложения.

### Задание 2. Обновить приложение

1. Создать deployment приложения с контейнерами nginx и multitool. Версию nginx взять 1.19. Количество реплик — 5.
2. Обновить версию nginx в приложении до версии 1.20, сократив время обновления до минимума. Приложение должно быть доступно.
3. Попытаться обновить nginx до версии 1.28, приложение должно оставаться доступным.
4. Откатиться после неудачного обновления.

## Дополнительные задания — со звёздочкой*

Задания дополнительные, необязательные к выполнению, они не повлияют на получение зачёта по домашнему заданию. **Но мы настоятельно рекомендуем вам выполнять все задания со звёздочкой.** Это поможет лучше разобраться в материале.   

### Задание 3*. Создать Canary deployment

1. Создать два deployment'а приложения nginx.
2. При помощи разных ConfigMap сделать две версии приложения — веб-страницы.
3. С помощью ingress создать канареечный деплоймент, чтобы можно было часть трафика перебросить на разные версии приложения.

### Правила приёма работы

1. Домашняя работа оформляется в своем Git-репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Файл README.md должен содержать скриншоты вывода необходимых команд, а также скриншоты результатов.
3. Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.

# Решение


## Задание 1 

```
Я бы выбрал стратегию обновления развертывания с помощью Rolling Update

1. Ограниченные ресурсы и запас в 20% в менее загруженный момент.
   - Стратегия Rolling Update позволяет обновлять приложение постепенно, заменяя старые реплики на новые. Таким образом, мы не перегружаем кластер и можем обновляться без простоев.

2. Новые версии приложения не умеют работать со старыми.
   - Старые и новые версии приложения не совместимы, поэтому постепенное обновление реплик является более безопасным подходом, чем, например, Recreate, когда все старые реплики будут остановлены, а затем запущены новые.

3. Необходимость обновления без простоев.
   - Rolling Update позволяет обновлять приложение с минимальным простоем, так как во время обновления часть реплик остается доступной.

Таким образом, стратегия Rolling Update кажется наиболее подходящей в данном случае. Она позволит безопасно обновить приложение, сохраняя его доступность и не перегружая кластер.
```


## Задание 2


* Создал виртуальные машины в яндекс облаке 

![Alt text](https://github.com/Fe1br0/kube-homeworks/blob/main/3.4/0.jpg)



* Подключаемся к виртуальной машине master01 и начинаем ее конфигурирование с помощью kubespray аналогично тому , как делали в прошлом задании 

```bash
apt-get update -y
apt-get install git pip -y
git clone https://github.com/kubernetes-sigs/kubespray
cd kubespray
pip3 install -r requirements.txt
cp -rfp inventory/sample inventory/mycluster
declare -a IPS=(10.131.0.3 10.131.0.15 10.131.0.34 10.131.0.35)
```



```Проверим состояния нод и подов в кластере```



![Alt text](https://github.com/Fe1br0/kube-homeworks/blob/main/3.4/Screenshot_1.jpg)


### Обновление приложения 

```Создадим первый yaml-файл deployment для приложений nginx и multitool. Версию nginx будем использовать 1.19. Количество реплик — 5```



![Alt text](https://github.com/Fe1br0/kube-homeworks/blob/main/3.4/2.jpg)



 ```Запускаем  deployment1.yaml и смотрим на результат```



![Alt text](https://github.com/Fe1br0/kube-homeworks/blob/main/3.4/3.jpg)



 ```Делаем второй  deployment для приложений nginx и multitool. С версией nginx  1.20. Количество реплик — 5.```



![Alt text](https://github.com/Fe1br0/kube-homeworks/blob/main/3.4/4.jpg)



 
 ```Создадим третий  deployment для приложений nginx и multitool. Версию nginx будем использовать 1.28 (пока не существующая). Количество реплик — 5.```

 ```Попробуем выполнить развертывание deployment3.yaml для обновления работающих подов и проверим результат```




![Alt text](https://github.com/Fe1br0/kube-homeworks/blob/main/3.4/5.jpg)





  ```Возникли проблемы с поднятием подов. Продолжает работает 3 пода старой корректной версии поскольку в deployment был задан параметр maxUnavailable: 50%. Проверим более детально, какая проблема возникла при попытке запуска новых подов```



![Alt text](https://github.com/Fe1br0/kube-homeworks/blob/main/3.4/6.jpg)



```По логам видим,  что неполучается  выполнить загрузку из Container Registry образа nginx версии 1.28 т.к. его не существует```


 ```Проверим историю всех развертываний deployment```



![Alt text](https://github.com/Fe1br0/kube-homeworks/blob/main/3.4/7.jpg)




```Выполним откат к предыдущей (2-й по списку) ревизии deployment с nginx версии 1.20 ```



![Alt text](https://github.com/Fe1br0/kube-homeworks/blob/main/3.4/8.jpg)




```Видно, что откат выполнен успешно. Развернуто 5 подов, которые используют nginx версии 1.20. Давайте проверим текущее состояние ревизий нашего deployment.```




![Alt text](https://github.com/Fe1br0/kube-homeworks/blob/main/3.4/9.jpg)

